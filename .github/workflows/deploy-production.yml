name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  contents: read
  checks: read

jobs:
  # Wait for canary checks to pass before deploying
  wait-for-canary:
    name: Wait for canary checks
    runs-on: ubuntu-latest
    steps:
      - name: Wait for prod-canary workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Run production canary checks'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

  deploy-convex:
    name: Deploy Convex to Production
    runs-on: ubuntu-latest
    needs: wait-for-canary
    environment:
      name: production
      url: https://outgoing-setter-201.convex.cloud

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.8"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure Convex deployment
        working-directory: apps/server
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: |
          # Create .convex directory
          mkdir -p .convex

          # Production deployment URL from Convex dashboard
          echo "https://outgoing-setter-201.convex.cloud" > .convex/deployment_url.txt

          # Create .env.local with deployment configuration
          cat > .env.local << EOF
          # Convex production deployment configuration
          CONVEX_DEPLOYMENT=outgoing-setter-201
          NEXT_PUBLIC_CONVEX_URL=https://outgoing-setter-201.convex.cloud
          EOF

          echo "‚úÖ Convex deployment configured"

      - name: Deploy Convex schema and functions
        working-directory: apps/server
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: |
          echo "‚òÅÔ∏è  Deploying to Convex production..."
          bunx convex deploy --yes
          echo "‚úÖ Convex deployment complete!"

      - name: Verify deployment
        working-directory: apps/server
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: |
          echo "üìä Checking deployment status..."
          DEPLOYMENT_URL=$(bunx convex env get NEXT_PUBLIC_CONVEX_URL 2>&1 || echo "")
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "‚úÖ Production URL: $DEPLOYMENT_URL"
          else
            echo "‚ö†Ô∏è  Could not retrieve production URL, but deployment may have succeeded"
          fi

      - name: Run database migrations
        working-directory: apps/server
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: |
          echo "üîÑ Running database migrations..."

          # Run stats initialization migration (idempotent)
          echo "Running initializeStats migration..."
          bunx convex run migrations:initializeStats '{"force": false}' || echo "‚ö†Ô∏è  initializeStats migration skipped or already completed"

          # Run message count backfill migration (idempotent - skips existing)
          echo "Running backfillMessageCounts migration..."
          bunx convex run migrations:backfillMessageCounts '{"skipExisting": true}' || echo "‚ö†Ô∏è  backfillMessageCounts migration skipped or already completed"

          # Run onboarding fields removal migration (idempotent)
          echo "Running removeOnboardingFields migration..."
          bunx convex run migrations:removeOnboardingFields || echo "‚ö†Ô∏è  removeOnboardingFields migration skipped or already completed"

          echo "‚úÖ Migrations complete!"

      - name: Verify data consistency
        working-directory: apps/server
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}
        run: |
          echo "üîç Verifying data consistency..."
          bunx convex run migrations:verifyMessageCounts || echo "‚ö†Ô∏è  Verification check encountered issues"

      - name: Post deployment summary
        if: always()
        run: |
          echo "üéâ Deployment Summary"
          echo "===================="
          echo "Status: ${{ job.status }}"
          echo "Deployment: https://outgoing-setter-201.convex.cloud"
          echo "Dashboard: https://dashboard.convex.dev/t/outgoing-setter-201"
          echo ""
          echo "Next steps:"
          echo "1. Vercel will auto-deploy web app on push to main"
          echo "2. Monitor deployment at dashboard link above"
          echo "3. Run manual smoke tests if needed"

      - name: Generate changelog entry
        if: success()
        env:
          AUTOCHANGELOG_WEBHOOK_URL: ${{ secrets.AUTOCHANGELOG_WEBHOOK_URL }}
          AUTOCHANGELOG_SECRET: ${{ secrets.AUTOCHANGELOG_SECRET }}
          AUTOCHANGELOG_WEBHOOK_SECRET: ${{ secrets.AUTOCHANGELOG_WEBHOOK_SECRET }}
        run: |
          echo "üìù Generating changelog entry..."

          # Support both secret names:
          # - AUTOCHANGELOG_SECRET (preferred, matches AutoChangelog docs)
          # - AUTOCHANGELOG_WEBHOOK_SECRET (legacy name used in this repo)
          SIGNING_SECRET="${AUTOCHANGELOG_SECRET:-$AUTOCHANGELOG_WEBHOOK_SECRET}"

          # Skip if secrets are not configured
          if [ -z "$AUTOCHANGELOG_WEBHOOK_URL" ] || [ -z "$SIGNING_SECRET" ]; then
            echo "‚ö†Ô∏è  AutoChangelog secrets not configured, skipping changelog generation"
            exit 0
          fi

          # Get the latest git tag for version, or use patch bump
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$VERSION" ]; then
            BODY="{\"version\": \"$VERSION\"}"
          else
            BODY='{"bump": "patch"}'
          fi

          # Compute HMAC-SHA256 signature
          SIGNATURE="sha256=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$SIGNING_SECRET" | cut -d' ' -f2)"

          # Send webhook request
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$AUTOCHANGELOG_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Signature: $SIGNATURE" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Changelog entry generated successfully"
            echo "$RESPONSE_BODY"
          else
            echo "‚ö†Ô∏è  Changelog generation returned HTTP $HTTP_CODE (non-fatal)"
            echo "$RESPONSE_BODY"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Check CONVEX_DEPLOY_KEY is set correctly in GitHub Secrets"
          echo "2. Verify production deployment URL: https://outgoing-setter-201.convex.cloud"
          echo "3. Review Convex dashboard for errors: https://dashboard.convex.dev/t/outgoing-setter-201"
          echo "4. Check migration logs above for specific errors"
          echo ""
          echo "To manually deploy:"
          echo "  bun run deploy"
          exit 1
